version: "3.9"

services:
  # =========================
  # Image build base
  # =========================
  kohya-base:
    build:
      context: .
      dockerfile: Dockerfile
    image: kohya-sd-scripts:local
    profiles: ["build"]

  # =========================
  # Character LoRA
  # =========================
  kohya-char:
    image: kohya-sd-scripts:local
    container_name: kohya-lora-char
    profiles: ["char"]

    gpus: all
    tty: true
    stdin_open: true
    working_dir: /workspace
    user: "${UID:-1000}:${GID:-1000}"

    environment:
      - HF_HOME=/workspace/.cache/huggingface
      - TORCH_HOME=/workspace/.cache/torch
      - TRANSFORMERS_CACHE=/workspace/.cache/huggingface
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility

    volumes:
      - ../datasets:/workspace/datasets
      - ../models:/workspace/models
      - ../output:/workspace/output
      - ../configs:/workspace/configs
      - ../.cache:/workspace/.cache

    command:
      [
        "bash",
        "-lc",
        "run_lora char /workspace/configs/lora/char_lora.toml /workspace/datasets/normalized/characters \"${DATASET_SET:-}\"",
      ]

  # =========================
  # Style LoRA
  # =========================
  kohya-style:
    image: kohya-sd-scripts:local
    container_name: kohya-lora-style
    profiles: ["style"]

    gpus: all
    tty: true
    stdin_open: true
    working_dir: /workspace
    user: "${UID:-1000}:${GID:-1000}"

    environment:
      - HF_HOME=/workspace/.cache/huggingface
      - TORCH_HOME=/workspace/.cache/torch
      - TRANSFORMERS_CACHE=/workspace/.cache/huggingface
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility

    volumes:
      - ../datasets:/workspace/datasets
      - ../models:/workspace/models
      - ../output:/workspace/output
      - ../configs:/workspace/configs
      - ../.cache:/workspace/.cache

    command:
      [
        "bash",
        "-lc",
        "run_lora style /workspace/configs/lora/style_lora.toml /workspace/datasets/normalized/style \"${DATASET_SET:-}\"",
      ]
