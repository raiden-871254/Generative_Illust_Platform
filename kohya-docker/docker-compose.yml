# kohya-docker/docker-compose.yml
services:
  kohya:
    build:
      context: .
      dockerfile: Dockerfile
    image: kohya-sd-scripts:local
    container_name: kohya-sd-scripts
    working_dir: /workspace
    tty: true
    stdin_open: true

    # NVIDIA GPU を使う（Docker側に nvidia-container-toolkit が入っている前提）
    gpus: all

    # 生成物のパーミッション事故を避ける（Linux想定）
    user: "${UID:-1000}:${GID:-1000}"

    environment:
      - HF_HOME=/workspace/.cache/huggingface
      - TORCH_HOME=/workspace/.cache/torch
      - TRANSFORMERS_CACHE=/workspace/.cache/huggingface
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=compute,utility

    volumes:
      # 学習データ
      - ../datasets:/workspace/datasets
      # モデル置き場（checkpoints / lora / vae）
      - ../models:/workspace/models
      # 出力（学習済みLoRAなど）
      - ../output:/workspace/output
      # 設定（任意）
      - ../configs:/workspace/configs

      # キャッシュ（リポジトリ配下に閉じる）
      - ../.cache:/workspace/.cache
