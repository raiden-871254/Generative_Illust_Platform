Style LoRA 自動化リポジトリ 仕様書
=================================

1. 目的
--------

本リポジトリは、Stable Diffusion 用 Style LoRA を
自己蒸留 + 人間選別 によって長期的に育成・管理するための制御基盤である。

設計目標は以下の通り。

- AI が得意な分布を起点とする
- 人間の作業を「良い生成物を選ぶ」みに限定する
- 再現性、ロールバック性、履歴の可読性を確保する
- 長期運用しても混乱しない構造にする

------------------------------------------------------------

2. 基本思想
------------

- Git は「制御コード・設定・判断履歴」のみを管理する
- 画像データ、生成物、学習ログ、ComfyUI models は Git 管理しない
- 制御系（Make / Python）と生成系（ComfyUI）は完全に分離する
- LoRA はセマンティックバージョニング（SemVer）で管理する

------------------------------------------------------------

3. 実行環境前提
---------------

3.1 Python 実行環境

- すべての Python スクリプトは uv 環境で実行する
- Makefile は uv が有効化されている前提で実行されるものとする

3.2 ComfyUI

- ComfyUI は Docker コンテナで稼働する
- ComfyUI の models ディレクトリはリポジトリ外に存在する
- Docker volume 経由でマウントされる

重要：
制御系 Python から ComfyUI の models を直接操作してはならない。

------------------------------------------------------------

1. リポジトリ構成（イメージ）
-----------------------------

※ 実際のディレクトリ名は異なってもよい。
※ 役割が一致していることを重視する。

repo/
  Makefile
  VERSION

  scripts/      制御用 Python スクリプト
  configs/      学習・生成設定ファイル
  prompts/      比較用の固定プロンプト
  docs/         運用・仕様ドキュメント

  datasets/     画像データ（Git 管理外）
  lora/         LoRA 成果物
  outputs/      比較生成結果（Git 管理外）
  runs/         学習ログ（Git 管理外）

------------------------------------------------------------

5. datasets 運用仕様
--------------------

5.1 データフロー（固定）

raw -> normalized -> picked -> staging -> train

5.2 raw

- インターネット等から収集した画像の原本
- 編集しない
- Git 管理しない
- 必要に応じて外部ストレージや symlink を利用してよい

5.3 normalized

- raw を入力として生成される正規化画像
- リサイズ、RGB 化、拡張子統一などを行う
- scripts/resize_dataset.py によって生成される
- Git 管理しない

5.4 picked

- 人間が「良い」と判断した画像のみを置くディレクトリ
- 人間が直接触る唯一の場所
- ここに入ることが学習意思を意味する
- Git 管理しない

5.5 staging

- 学習投入直前の最終データ
- picked から自動生成される
- dataset_hash を計算し、学習 meta に記録する
- Git 管理しない
- 人間が直接編集してはならない

------------------------------------------------------------

6. resize_dataset.py の役割
----------------------------

- 入力ディレクトリは datasets/raw
- 出力ディレクトリは datasets/normalized
- アスペクト比を維持したまま SD 学習向けサイズに正規化する
- 学習処理や ComfyUI 生成には直接関与しない
- 前処理専用スクリプトと位置付ける

------------------------------------------------------------

7. LoRA バージョニング仕様（SemVer）
------------------------------------

形式：
MAJOR.MINOR.PATCH

意味：
- MAJOR
  設計思想が変わる変更
  例：ベースモデル変更、学習方式刷新

- MINOR
  採用された LoRA
  プロダクション扱いの成果物

- PATCH
  試行錯誤用バージョン
  採用・不採用に関わらず増加させる

------------------------------------------------------------

8. 運用ルール
-------------

- 通常作業は PATCH を進めて行う
- 採用判断が出た場合のみ MINOR を進める
- VERSION ファイルは「現在の作業系統」を指す
- 採用済み MINOR を上書きしてはならない

------------------------------------------------------------

9. ロールバック仕様
--------------------

- ロールバック時、最新の MINOR を削除してはならない
- 巻き戻し前の最新 MINOR は必ず凍結コピーする

命名規則：
<元のバージョン>__rb<戻り先バージョン>

例：
1.5.0__rb1.4.0

------------------------------------------------------------

10. Makefile に求められる機能
------------------------------

Makefile は以下の操作を提供すること。

- init
  初期ディレクトリ作成、pre-commit 導入

- normalize
  raw -> normalized を生成（resize_dataset.py を使用）

- stage
  picked -> staging を生成、dataset_hash を計算

- bump_patch
  VERSION の PATCH を +1

- train
  staging を入力として LoRA 学習を実行
  lora/working に safetensors を出力
  meta.json を生成する

- compare
  固定プロンプト + 固定 seed による比較生成
  outputs に結果を出力する

- promote
  最新 working LoRA を次の MINOR に昇格
  lora/releases に保存
  VERSION を更新する

- rollback
  指定 MINOR へ戻す
  巻き戻し前の MINOR を凍結コピーする

------------------------------------------------------------

11. meta.json 必須項目
----------------------

- version
- promoted_from_version
- base_model
- dataset_hash
- train_config_hash
- compare_config_hash
- created_at
- promoted_at
- 人間による自由メモ（テキスト）

------------------------------------------------------------

12. 禁止事項
------------

- picked を直接学習に使用すること
- models を Git 管理すること
- staging を人間が直接編集すること
- 意図のない VERSION 書き換え

------------------------------------------------------------

13. 人間の責務
---------------

- 良い生成結果を picked に移動する
- compare 結果を見て採用判断を行う
- それ以外の作業はすべて自動化する

------------------------------------------------------------

14. ゴール状態
--------------

- 半年後に見ても設計意図が理解できる
- 作風進化の履歴が SemVer に刻まれている
- ロールバックが即座に行える
- 人間が疲れずに運用できる
